<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mapa Interativo do ParanÃ¡ â€” IBGE</title>

<!-- amCharts 5 -->
<script src="https://cdn.amcharts.com/lib/5/index.js"></script>
<script src="https://cdn.amcharts.com/lib/5/map.js"></script>
<script src="https://cdn.amcharts.com/lib/5/geodata/brazilLow.js"></script>
<script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

<style>
  html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    background: #f0f8f5;
    font-family: Arial, sans-serif;
  }
  #mapa-parana {
    width: 100%;
    height: 100vh;
  }
  .am5-tooltip {
    font-size: 13px;
  }
</style>
</head>

<body>
<div id="mapa-parana"></div>

<script>
am5.ready(function() {

  // ðŸŒ Inicializa o mapa
  var root = am5.Root.new("mapa-parana");
  root.setThemes([am5themes_Animated.new(root)]);

  var chart = root.container.children.push(am5map.MapChart.new(root, {
    projection: am5map.geoMercator(),
    panX: "translateX",
    panY: "translateY",
    wheelY: "zoom"
  }));

  // ðŸŽ¨ Paleta de cores das 10 mesorregiÃµes do ParanÃ¡ (IBGE)
  const coresPorRegiao = {
    "Noroeste Paranaense": "#FFD54F",
    "Norte Central Paranaense": "#4CAF50",
    "Norte Pioneiro Paranaense": "#81C784",
    "Centro Ocidental Paranaense": "#FBC02D",
    "Centro Oriental Paranaense": "#388E3C",
    "Oeste Paranaense": "#2196F3",
    "Sudoeste Paranaense": "#1976D2",
    "Centro-Sul Paranaense": "#8E24AA",
    "Sudeste Paranaense": "#5E35B1",
    "Metropolitana de Curitiba": "#E53935"
  };

  // ðŸ§  FunÃ§Ã£o para normalizar nomes (remove acentos, apÃ³strofos etc.)
  function normalizar(str) {
    return str.normalize("NFD")
              .replace(/[\u0300-\u036f]/g, "")
              .replace(/['â€™`Â´]/g, "")
              .replace(/-/g, " ")
              .toLowerCase()
              .trim();
  }

  // ðŸ“˜ RelaÃ§Ã£o das regiÃµes oficiais (resumida, mas pode ser expandida)
  const regioesMunicipios = {
    "Noroeste Paranaense": ["AltÃ´nia","Cianorte","MaringÃ¡","ParanavaÃ­","Umuarama"],
    "Norte Central Paranaense": ["Londrina","Apucarana","Arapongas","RolÃ¢ndia","Tamarana"],
    "Norte Pioneiro Paranaense": ["Jacarezinho","CornÃ©lio ProcÃ³pio","Ibaiti","AssaÃ­","CambarÃ¡"],
    "Centro Ocidental Paranaense": ["Campo MourÃ£o","GoioerÃª","Peabiru","Iretama","JaniÃ³polis"],
    "Centro Oriental Paranaense": ["Ponta Grossa","Castro","CarambeÃ­","TelÃªmaco Borba","Ortigueira"],
    "Oeste Paranaense": ["Cascavel","Toledo","Foz do IguaÃ§u","Medianeira","Palotina"],
    "Sudoeste Paranaense": ["Francisco BeltrÃ£o","Pato Branco","Dois Vizinhos","Realeza","AmpÃ©re"],
    "Centro-Sul Paranaense": ["Guarapuava","Pitanga","Laranjeiras do Sul","Irati","Palmital"],
    "Sudeste Paranaense": ["UniÃ£o da VitÃ³ria","SÃ£o Mateus do Sul","Cruz Machado","Paulo Frontin","Mallet"],
    "Metropolitana de Curitiba": ["Curitiba","Colombo","Pinhais","AraucÃ¡ria","SÃ£o JosÃ© dos Pinhais","Campo Largo"]
  };

  // ðŸŒŽ Carrega o GeoJSON do ParanÃ¡ (direto do IBGE)
  var geoUrl = "https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-41-mun.json";

  fetch(geoUrl)
    .then(response => response.json())
    .then(data => {

      var polygonSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {
        geoJSON: data
      }));

      polygonSeries.mapPolygons.template.setAll({
        tooltipText: "{name}",
        interactive: true,
        stroke: am5.color(0xffffff),
        strokeWidth: 0.25,
        cursorOverStyle: "pointer"
      });

      // ðŸŽ¨ Aplica cor conforme a sub-regiÃ£o
      polygonSeries.events.on("datavalidated", function() {
        polygonSeries.mapPolygons.each(function(polygon) {
          const nomeCidade = polygon.dataItem.dataContext.name;
          const nomeNormalizado = normalizar(nomeCidade);
          let regiaoEncontrada = null;

          for (const regiao in regioesMunicipios) {
            const listaNormalizada = regioesMunicipios[regiao].map(c => normalizar(c));
            if (listaNormalizada.includes(nomeNormalizado)) {
              regiaoEncontrada = regiao;
              break;
            }
          }

          const cor = regiaoEncontrada && coresPorRegiao[regiaoEncontrada]
            ? coresPorRegiao[regiaoEncontrada]
            : "#C8E6C9";
          polygon.set("fill", am5.color(cor));
        });
      });

      // âœ¨ Efeito hover
      polygonSeries.mapPolygons.template.states.create("hover", {
        fill: am5.color(0x43a047),
        scale: 1.05,
        shadowColor: am5.color(0x000000),
        shadowBlur: 6
      });

      // ðŸ–±ï¸ Clique envia nome da cidade para o Odoo
      polygonSeries.mapPolygons.template.events.on("click", function(ev) {
        const nomeCidade = ev.target.dataItem.dataContext.name;
        window.parent.postMessage({ city: nomeCidade }, "*");
        console.log("Cidade enviada:", nomeCidade);
      });

    })
    .catch(err => console.error("Erro ao carregar mapa:", err));

  chart.appear(1000, 100);
});
</script>

</body>
</html>
