<script>
am5.ready(async function() {
  const root = am5.Root.new("mapa-parana");
  root.setThemes([am5themes_Animated.new(root)]);
  const chart = root.container.children.push(am5map.MapChart.new(root,{
    projection: am5map.geoMercator(),
    panX:"translateX", panY:"translateY", wheelY:"zoom"
  }));

  const coresPorRegiao = {
    "Noroeste Paranaense": "#FFD54F",
    "Norte Central Paranaense": "#4CAF50",
    "Norte Pioneiro Paranaense": "#81C784",
    "Centro Ocidental Paranaense": "#FBC02D",
    "Centro Oriental Paranaense": "#388E3C",
    "Oeste Paranaense": "#2196F3",
    "Sudoeste Paranaense": "#1976D2",
    "Centro-Sul Paranaense": "#8E24AA",
    "Sudeste Paranaense": "#5E35B1",
    "Metropolitana de Curitiba": "#E53935"
  };

  // üó∫Ô∏è GeoJSON confi√°vel
  const geoUrl = "https://raw.githubusercontent.com/fititnt/open-geodata-pr/master/geojson/geojs-41-mun.json";
  let geoData;
  try {
    const resp = await fetch(geoUrl);
    geoData = await resp.json();
    console.log("‚úÖ GeoJSON carregado:", geoData.features.length, "munic√≠pios");
  } catch (e) {
    console.error("‚ùå Erro ao carregar GeoJSON:", e);
    return;
  }

  // üìÅ JSON de Regi√µes
  let regioesMunicipios = {};
  try {
    const regioesResp = await fetch("https://raw.githubusercontent.com/gustavosampaio-dev/pvgustavosampaio.github.io/main/regioes-pr.json");
    regioesMunicipios = await regioesResp.json();
    console.log("‚úÖ Regi√µes carregadas:", Object.keys(regioesMunicipios));
  } catch (e) {
    console.warn("‚ö†Ô∏è Erro ao carregar regioes-pr.json:", e);
  }

  const polygonSeries = chart.series.push(am5map.MapPolygonSeries.new(root,{geoJSON:geoData}));

  polygonSeries.mapPolygons.template.setAll({
    tooltipText:"{name}",
    interactive:true,
    stroke:am5.color(0xffffff),
    strokeWidth:0.25,
    cursorOverStyle:"pointer"
  });

  // üé® Aplicar cores
  polygonSeries.events.on("datavalidated", function() {
    polygonSeries.mapPolygons.each(function(polygon) {
      const nomeCidade = polygon.dataItem.dataContext.name;
      let regiaoEncontrada = null;

      for (const regiao in regioesMunicipios) {
        if (regioesMunicipios[regiao].includes(nomeCidade)) {
          regiaoEncontrada = regiao;
          break;
        }
      }

      const cor = regiaoEncontrada && coresPorRegiao[regiaoEncontrada]
        ? coresPorRegiao[regiaoEncontrada]
        : "#C8E6C9";
      polygon.set("fill", am5.color(cor));
    });
  });

  polygonSeries.mapPolygons.template.states.create("hover",{
    fill:am5.color(0x43a047),
    scale:1.05,
    shadowColor:am5.color(0x000000),
    shadowBlur:6
  });

  polygonSeries.mapPolygons.template.events.on("click",function(ev){
    const nomeCidade=ev.target.dataItem.dataContext.name;
    window.parent.postMessage({city:nomeCidade},"*");
    console.log("üü¢ Clique:", nomeCidade);
  });

  chart.appear(1000,100);
});
</script>
